<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HIIT Trainer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles */
    :root { color-scheme: light dark; }
    html, body, #root { height: 100%; }
    body { 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji", "Segoe UI Emoji"; 
      margin: 0;
      padding: 0;
      background-color: #dbeafe !important;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body style="background-color: #dbeafe;">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useReducer, useRef, useState } = React;

    /** HIIT Trainer — Warm-up • Workout • Cool-down with Skips
     * Skippable 5-min warm-up and cool-down using the same Ex model; persisted preferences.
     */

    // Icons (inline to avoid deps)
    const Icon = ({ type, className = "w-8 h-8" }) => {
      const common = { fill: "none", stroke: "currentColor", strokeWidth: 1.6, strokeLinecap: "round", strokeLinejoin: "round" };
      switch (type) {
        case "squat":
          return (<svg viewBox="0 0 64 64" className={className}><circle cx="32" cy="10" r="6" {...common} /><path d="M32 16v10M20 26h24" {...common} /><path d="M20 26l-6 10m30-10 6 10" {...common} /><path d="M26 38h12m-12 0-6 12m18-12 6 12" {...common} /></svg>);
        case "pushup":
          return (<svg viewBox="0 0 64 64" className={className}><rect x="8" y="36" width="48" height="6" rx="3" {...common} /><circle cx="12" cy="32" r="4" {...common} /><path d="M16 34h34l6-6" {...common} /></svg>);
        case "plank":
          return (<svg viewBox="0 0 64 64" className={className}><rect x="10" y="38" width="44" height="6" rx="3" {...common} /><circle cx="12" cy="34" r="4" {...common} /><path d="M16 36h34" {...common} /></svg>);
        case "jump":
          return (<svg viewBox="0 0 64 64" className={className}><circle cx="32" cy="12" r="6" {...common} /><path d="M32 18v10m-8 0h16" {...common} /><path d="M24 28l-8 8m24-8 8 8" {...common} /><path d="M20 48h24" {...common} /></svg>);
        case "mobility":
          return (<svg viewBox="0 0 64 64" className={className}><path d="M12 32c0-11 9-20 20-20s20 9 20 20-9 20-20 20S12 43 12 32Z" {...common} /><path d="M18 30c6 2 22 2 28 0" {...common} /><path d="M22 40c4-2 16-2 20 0" {...common} /></svg>);
        case "core":
        default:
          return (<svg viewBox="0 0 64 64" className={className}><circle cx="32" cy="32" r="14" {...common} /><path d="M32 18v28M18 32h28" {...common} /></svg>);
      }
    };

    // Utils
    const fmt = (s) => `${Math.floor(s / 60)}:${String(s % 60).padStart(2, "0")}`;
    const csvEscape = (val) => `"${String(val).replace(/"/g, '""')}"`;
    const localTimestamp = (iso) => {
      try {
        const d = new Date(iso), pad = (n) => String(n).padStart(2, "0");
        const offMin = -d.getTimezoneOffset(), sign = offMin >= 0 ? "+" : "-";
        const abs = Math.abs(offMin), offH = pad(Math.floor(abs / 60)), offM = pad(abs % 60);
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())} ${sign}${offH}:${offM}`;
      } catch { return iso; }
    };
    const MOTIVATIONS = ["Let's go!", "You got this!", "Stay strong!", "Push it!", "Own it!", "Keep breathing!"];

    // Exercise builders
    const I = (name, type, desc, work = 30, rest = 20) =>
      ({ name, type, desc, cues: ["Neutral spine", "Steady breathing"], mode: "interval", work, rest });
    const H = (name, type, desc, hold = 30, rest = 20) =>
      ({ name, type, desc, cues: ["Slow breaths", "Stay relaxed"], mode: "hold", hold, rest });
    const T = (name, type, desc, work = 20, rest = 10, sets = 8) =>
      ({ name, type, desc, cues: ["Explosive but controlled"], mode: "tabata", work, rest, sets });

    // 5-min templates
    const WARMUP_TEMPLATE = [
      I("March in Place", "jump", "Light cardio — tall posture.", 40, 20),
      I("Arm Circles", "mobility", "Big, smooth circles.", 40, 20),
      I("Hip Openers", "mobility", "Open/close the gate.", 40, 20),
      I("Inchworm Walkouts", "core", "Slow, controlled.", 40, 20),
      I("Jumping Jacks (easy)", "jump", "Land softly.", 40, 20),
    ];
    const COOLDOWN_TEMPLATE = [
      H("Deep Squat Hold", "mobility", "Chest up.", 40, 20),
      H("Hip Flexor Stretch (L)", "mobility", "Glute squeeze.", 40, 20),
      H("Hip Flexor Stretch (R)", "mobility", "Glute squeeze.", 40, 20),
      H("Hamstring Fold", "mobility", "Relax neck.", 40, 20),
      H("Child's Pose", "mobility", "Slow nasal breaths.", 40, 20),
    ];

    // Base plan with warm-up/cool-down
    const BASE_DAYS = [
      { title: "Full Body Starter", rounds: 3, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [I("Bodyweight Squats", "squat", "Feet shoulder-width; drive through heels."),
                  I("Incline Push-ups", "pushup", "Hands elevated; chest to edge."),
                  H("Plank Hold", "plank", "Elbows under shoulders.", 30, 20)] },
      { title: "Lower Burn + Core", rounds: 3, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [I("Reverse Lunges", "squat", "Long step back; upright torso."),
                  H("Side Plank (Left)", "plank", "Hips high.", 25, 15),
                  H("Side Plank (Right)", "plank", "Hips high.", 25, 15)] },
      { title: "Push Focus", rounds: 3, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [I("Push-ups", "pushup", "Elbows ~45°; full lockout."),
                  I("Pike Shoulder Taps", "pushup", "Stable hips."),
                  H("Hollow Hold", "core", "Lower back down.", 25, 20)] },
      { title: "Tabata Engine", rounds: 1, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [T("Jumping Jacks", "jump", "Land softly.", 20, 10, 8),
                  T("High Knees", "jump", "Knees hip height.", 20, 10, 8)] },
      { title: "Mobility Flow", rounds: 2, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [H("Deep Squat Hold", "mobility", "Chest up.", 40, 20),
                  H("Hip Flexor Stretch (L/R)", "mobility", "Glute squeeze.", 30, 15),
                  H("Thoracic Opener", "mobility", "Slow breaths.", 30, 15)] },
      { title: "Leg Power", rounds: 3, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [I("Squat Jumps", "jump", "Soft landing."),
                  I("Split Squats", "squat", "Knee over mid-foot.", 30, 20),
                  H("Wall Sit", "core", "Knees 90°.", 30, 20)] },
      { title: "Core Finisher", rounds: 3, warmup: WARMUP_TEMPLATE, cooldown: COOLDOWN_TEMPLATE,
        circuit: [I("Dead Bug", "core", "Ribs down."),
                  H("Plank", "plank", "Squeeze glutes.", 40, 20),
                  I("Mountain Climbers", "core", "Hips steady.", 30, 15)] },
    ];

    // Week variants (workout only)
    const WEEK_VARIANTS = [
      (d) => d,
      (d) => ({ ...d, rounds: d.rounds + 1,
        circuit: d.circuit.map((ex) =>
          ex.mode === "interval" ? { ...ex, work: (ex.work ?? 30) + 10 } :
          ex.mode === "hold" ? { ...ex, hold: (ex.hold ?? 30) + 10 } : ex) }),
      (d) => ({ ...d,
        circuit: d.circuit.map((ex) => {
          if (ex.mode === "interval") return { ...ex, rest: Math.max(10, (ex.rest ?? 20) - 5) };
          if (ex.mode === "tabata") return { ...ex, sets: (ex.sets ?? 8) + 2 };
          if (ex.mode === "hold") return { ...ex, rest: Math.max(5, (ex.rest ?? 10) - 5) };
          return ex;
        }) }),
      (d) => ({ ...d, rounds: d.rounds + 1,
        circuit: d.circuit.map((ex) => {
          if (ex.mode === "interval") return { ...ex, work: (ex.work ?? 30) + 10, rest: Math.max(10, (ex.rest ?? 20) - 5) };
          if (ex.mode === "tabata") return { ...ex, sets: (ex.sets ?? 8) + 2 };
          if (ex.mode === "hold") return { ...ex, hold: (ex.hold ?? 30) + 10 };
          return ex;
        }) }),
    ];

    const buildPlan = () =>
      WEEK_VARIANTS.map((transform, i) => ({
        name: `Week ${i + 1}`,
        days: BASE_DAYS.map((d) =>
          transform({ ...d, warmup: d.warmup.map((x) => ({ ...x })), cooldown: d.cooldown.map((x) => ({ ...x })), circuit: d.circuit.map((x) => ({ ...x })) })
        ),
      }));

    // Queue helpers
    function pushEx(steps, ex) {
      if (ex.mode === "interval") {
        steps.push({ label: `${ex.name} — WORK`, icon: ex.type, type: "work", seconds: ex.work ?? 30, cue: ex.name });
        const restSec = ex.rest ?? 20;
        steps.push({ label: `REST`, icon: "core", type: "rest", seconds: restSec, cue: `Rest, ${restSec} seconds` });
      } else if (ex.mode === "hold") {
        steps.push({ label: `${ex.name} — HOLD`, icon: ex.type, type: "work", seconds: ex.hold ?? 30, cue: ex.name });
        const restSec = ex.rest ?? 20;
        steps.push({ label: `REST`, icon: "core", type: "rest", seconds: restSec, cue: `Rest, ${restSec} seconds` });
      } else if (ex.mode === "tabata") {
        for (let i = 0; i < (ex.sets ?? 8); i++) {
          steps.push({ label: `${ex.name} (${i+1}/${ex.sets ?? 8})`, icon: ex.type, type: "work", seconds: ex.work ?? 20, cue: ex.name });
          const restSec = ex.rest ?? 10;
          steps.push({ label: `REST`, icon: "core", type: "rest", seconds: restSec, cue: `Rest, ${restSec} seconds` });
        }
      }
    }

    function buildQueue({ day, skipWarmup, skipCooldown }) {
      const steps = [];
      if (!skipWarmup) {
        steps.push({ label: "Warm-up Start", icon: "core", type: "rest", seconds: 3, cue: "Let's warm up!" });
        day.warmup.forEach((ex) => pushEx(steps, ex));
        steps.push({ label: "Ready for Workout?", icon: "core", type: "pause", seconds: 0, cue: "Warm-up complete! Press Start when ready for workout." });
      }
      for (let r = 0; r < day.rounds; r++) {
        steps.push({ label: `Round ${r + 1}`, icon: "core", type: "rest", seconds: 5, cue: `Round ${r + 1}, ready to go` });
        day.circuit.forEach((ex) => pushEx(steps, ex));
      }
      if (!skipCooldown) {
        steps.push({ label: "Cool-down Start", icon: "core", type: "rest", seconds: 3, cue: "Time to cool down" });
        day.cooldown.forEach((ex) => pushEx(steps, ex));
      }
      steps.push({ label: "Complete!", icon: "core", type: "rest", seconds: 5, cue: "Great work!" });
      return steps;
    }

    // Main Component
    function App() {
      const PLAN = useMemo(buildPlan, []);
      const [week, setWeek] = useState(() => parseInt(localStorage.getItem("hiitWeek") || "0", 10));
      const [dayIdx, setDayIdx] = useState(() => parseInt(localStorage.getItem("hiitDay") || "0", 10));
      const [skipWarmup, setSkipWarmup] = useState(() => localStorage.getItem("hiitSkipWarmup") === "true");
      const [skipCooldown, setSkipCooldown] = useState(() => localStorage.getItem("hiitSkipCooldown") === "true");
      const [appendMode, setAppendMode] = useState(() => localStorage.getItem("hiitAppendMode") === "true");
      const [logs, setLogs] = useState(() => {
        try { return JSON.parse(localStorage.getItem("hiitLogs") || "[]"); } catch { return []; }
      });

      const day = PLAN[week]?.days[dayIdx] || PLAN[0].days[0];
      const queue = useMemo(() => buildQueue({ day, skipWarmup, skipCooldown }), [day, skipWarmup, skipCooldown]);
      const totalDuration = useMemo(() => queue.reduce((acc, s) => acc + s.seconds, 0), [queue]);

      useEffect(() => { localStorage.setItem("hiitWeek", String(week)); }, [week]);
      useEffect(() => { localStorage.setItem("hiitDay", String(dayIdx)); }, [dayIdx]);
      useEffect(() => { localStorage.setItem("hiitSkipWarmup", String(skipWarmup)); }, [skipWarmup]);
      useEffect(() => { localStorage.setItem("hiitSkipCooldown", String(skipCooldown)); }, [skipCooldown]);
      useEffect(() => { localStorage.setItem("hiitAppendMode", String(appendMode)); }, [appendMode]);
      useEffect(() => { localStorage.setItem("hiitLogs", JSON.stringify(logs)); }, [logs]);

      // Timer state
      const [state, dispatch] = useReducer((s, a) => {
        if (a.type === "start") return { ...s, running: true };
        if (a.type === "pause") return { ...s, running: false };
        if (a.type === "reset") return { stepIdx: 0, remaining: queue[0]?.seconds || 0, running: false };
        if (a.type === "tick") {
          if (s.remaining <= 1) {
            const nextIdx = s.stepIdx + 1;
            if (nextIdx >= queue.length) return { stepIdx: s.stepIdx, remaining: 0, running: false };
            const nextStep = queue[nextIdx];
            // Auto-pause on pause steps
            if (nextStep.type === "pause") {
              return { stepIdx: nextIdx, remaining: nextStep.seconds, running: false };
            }
            return { stepIdx: nextIdx, remaining: queue[nextIdx].seconds, running: true };
          }
          return { ...s, remaining: s.remaining - 1 };
        }
        if (a.type === "skip") {
          const nextIdx = s.stepIdx + 1;
          if (nextIdx >= queue.length) return { stepIdx: s.stepIdx, remaining: 0, running: false };
          const nextStep = queue[nextIdx];
          // Auto-pause on pause steps
          if (nextStep.type === "pause") {
            return { stepIdx: nextIdx, remaining: nextStep.seconds, running: false };
          }
          return { stepIdx: nextIdx, remaining: queue[nextIdx].seconds, running: s.running };
        }
        return s;
      }, { stepIdx: 0, remaining: queue[0]?.seconds || 0, running: false });

      const [showBigCountdown, setShowBigCountdown] = useState(false);
      const [bigCountdownNumber, setBigCountdownNumber] = useState(0);

      const currentStep = queue[state.stepIdx] || queue[0];
      const progress = currentStep ? ((currentStep.seconds - state.remaining) / currentStep.seconds) * 100 : 0;

      // Find current exercise for form tips
      const currentExercise = useMemo(() => {
        const label = currentStep.label;
        const exName = label.split(" — ")[0].replace(/ \(\d+\/\d+\)$/, "");
        return [...day.warmup, ...day.circuit, ...day.cooldown].find((ex) => ex.name === exName);
      }, [currentStep, day]);

      // Voice - auto-select Samantha
      const [voices, setVoices] = useState([]);
      const [voice, setVoice] = useState(null);
      useEffect(() => {
        const load = () => {
          const vs = window.speechSynthesis?.getVoices() || [];
          setVoices(vs);
          // Auto-select Samantha voice
          const samantha = vs.find((v) => v.name.includes("Samantha"));
          if (samantha) setVoice(samantha);
        };
        load();
        window.speechSynthesis?.addEventListener("voiceschanged", load);
        return () => window.speechSynthesis?.removeEventListener("voiceschanged", load);
      }, []);

      const say = (text) => {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if (voice) u.voice = voice;
        window.speechSynthesis.speak(u);
      };

      // Wake Lock
      const wakeLockRef = useRef(null);
      const [wakeActive, setWakeActive] = useState(false);
      const wakeSupported = "wakeLock" in navigator;
      const requestWake = async () => {
        if (!wakeSupported) return;
        try {
          wakeLockRef.current = await navigator.wakeLock.request("screen");
          setWakeActive(true);
          wakeLockRef.current.addEventListener("release", () => setWakeActive(false));
        } catch {}
      };
      const releaseWake = async () => {
        if (wakeLockRef.current) {
          await wakeLockRef.current.release();
          wakeLockRef.current = null;
          setWakeActive(false);
        }
      };

      // Timer loop & announcements
      useEffect(() => {
        if (!state.running) return;
        const id = setInterval(() => dispatch({ type: "tick" }), 1000);
        return () => clearInterval(id);
      }, [state.running]);

      const prevStepRef = useRef(state.stepIdx);
      const prevRunningRef = useRef(state.running);
      const hasAnnouncedDuration = useRef(false);
      
      useEffect(() => {
        const stepChanged = state.stepIdx !== prevStepRef.current;
        const justStarted = state.running && !prevRunningRef.current;
        
        if (stepChanged) {
          prevStepRef.current = state.stepIdx;
          hasAnnouncedDuration.current = false;
          
          if (state.stepIdx === queue.length - 1) {
            const startT = Date.now() - (totalDuration - state.remaining) * 1000;
            const dur = Math.round((Date.now() - startT) / 1000);
            setLogs((prev) => [...prev, { ts: new Date().toISOString(), week: week + 1, day: dayIdx + 1, title: day.title, duration: dur }]);
          }
          if (currentStep.type === "pause") {
            say(currentStep.cue);
          } else if (currentStep.type === "work") {
            say(currentStep.cue);
          } else if (currentStep.type === "rest") {
            // Speak the cue immediately
            say(currentStep.cue);
          }
        } else if (justStarted) {
          // Handle case where user presses Start - announce the current step
          hasAnnouncedDuration.current = false;
          if (currentStep.type === "rest") {
            say(currentStep.cue);
          } else if (currentStep.type === "work") {
            say(currentStep.cue);
          }
        }
        
        prevRunningRef.current = state.running;
      }, [state.stepIdx, state.running, queue.length, totalDuration, state.remaining, currentStep, day.title, week, dayIdx]);

      // Announce exercise duration after 5 seconds
      useEffect(() => {
        if (state.running && currentStep.type === "work" && !hasAnnouncedDuration.current) {
          const elapsed = currentStep.seconds - state.remaining;
          if (elapsed >= 5) {
            hasAnnouncedDuration.current = true;
            say(`${state.remaining} seconds`);
          }
        }
      }, [state.remaining, state.running, currentStep]);

      useEffect(() => {
        if (state.running && currentStep.type === "rest") {
          // For round starts, show big countdown animation for 5-4-3-2-1
          if (currentStep.label.startsWith("Round") && state.remaining <= 5 && state.remaining >= 1) {
            setBigCountdownNumber(state.remaining);
            setShowBigCountdown(true);
            say(String(state.remaining));
            // Hide countdown after a brief moment
            setTimeout(() => setShowBigCountdown(false), 800);
          }
          // For other rest periods, countdown last 3 seconds as "three two one"
          else if (!currentStep.label.startsWith("Round") && state.remaining === 3) {
            say("Three, two, one");
          }
        }
      }, [state.remaining, state.running, currentStep]);

      // Controls
      const start = () => { requestWake(); dispatch({ type: "start" }); };
      const pause = () => dispatch({ type: "pause" });
      const skip = () => dispatch({ type: "skip" });
      const reset = () => dispatch({ type: "reset" });

      // CSV Export
      const exportCSV = () => {
        const cursor = parseInt(localStorage.getItem("hiitExportCursor") || "0", 10);
        const toExport = appendMode ? logs.slice(cursor) : logs;
        if (toExport.length === 0) { alert("No new logs to export."); return; }
        const header = "Date,Week,Day,Title,Duration (seconds)\n";
        const rows = toExport.map((l) => `${csvEscape(localTimestamp(l.ts))},${l.week},${l.day},${csvEscape(l.title)},${l.duration}`).join("\n");
        const blob = new Blob([header + rows], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `hiit-logs-${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        if (appendMode) localStorage.setItem("hiitExportCursor", String(logs.length));
      };

      return (
        <div className="min-h-screen p-4" style={{ backgroundColor: '#dbeafe' }}>
          {/* Big Countdown Overlay */}
          {showBigCountdown && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(30, 58, 95, 0.95)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 9999,
              animation: 'pulse 0.8s ease-out'
            }}>
              <div style={{
                fontSize: '20rem',
                fontWeight: 'bold',
                color: 'white',
                textShadow: '0 0 40px rgba(255,255,255,0.5)',
                animation: 'scaleIn 0.8s ease-out'
              }}>
                {bigCountdownNumber}
              </div>
            </div>
          )}
          
          <style>{`
            @keyframes scaleIn {
              from {
                transform: scale(0.5);
                opacity: 0;
              }
              to {
                transform: scale(1);
                opacity: 1;
              }
            }
          `}</style>

          <header className="max-w-7xl mx-auto mb-6">
            <h1 className="text-3xl font-bold text-center text-blue-900">HIIT Trainer</h1>
            <p className="text-center text-sm text-blue-700 mt-1">Warm-up • Workout • Cool-down</p>
          </header>

          <main className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Setup */}
            <section className="bg-white rounded-2xl shadow p-4 space-y-4">
              <h2 className="font-semibold text-lg">Setup</h2>

              <div>
                <label className="block text-sm mb-1 text-blue-900 font-medium">Week</label>
                <select className="w-full border border-blue-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={week} onChange={(e) => setWeek(parseInt(e.target.value, 10))}>
                  {PLAN.map((w, i) => (<option key={i} value={i}>{w.name}</option>))}
                </select>
              </div>

              <div>
                <label className="block text-sm mb-1 text-blue-900 font-medium">Day</label>
                <select className="w-full border border-blue-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={dayIdx} onChange={(e) => setDayIdx(parseInt(e.target.value, 10))}>
                  {PLAN[week].days.map((d, i) => (<option key={i} value={i}>{d.title}</option>))}
                </select>
              </div>

              <div className="flex items-center gap-4">
                <label className="flex items-center gap-2 text-sm text-blue-900 font-medium">
                  <input type="checkbox" checked={skipWarmup} onChange={(e) => setSkipWarmup(e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                  Skip Warm-up
                </label>
                <label className="flex items-center gap-2 text-sm text-blue-900 font-medium">
                  <input type="checkbox" checked={skipCooldown} onChange={(e) => setSkipCooldown(e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                  Skip Cool-down
                </label>
              </div>

              {/* Warm-up */}
              {!skipWarmup && (
                <div className="space-y-2">
                  <p className="text-sm text-blue-900 font-semibold">Warm-up • 5:00</p>
                  <div className="border rounded-xl divide-y" style={{ backgroundColor: '#1e3a8a', borderColor: '#1e40af' }}>
                    {day.warmup.map((ex, i) => (
                      <div key={`wu-${i}`} className="flex items-center gap-3 p-3">
                        <Icon type={ex.type} className="w-6 h-6 text-blue-200" />
                        <div className="flex-1">
                          <p className="font-medium text-white">{ex.name}</p>
                          <p className="text-xs text-blue-300">{ex.desc}</p>
                        </div>
                        <span className="text-xs text-blue-300">{ex.mode === "interval" ? `${ex.work}/${ex.rest}s` : `Hold ${ex.hold}s`}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Workout */}
              <div className="space-y-2">
                <p className="text-sm text-blue-900 font-semibold">Workout • {day.rounds} rounds</p>
                <div className="border rounded-xl divide-y" style={{ backgroundColor: '#1e3a8a', borderColor: '#1e40af' }}>
                  {day.circuit.map((ex, i) => (
                    <div key={`ex-${i}`} className="flex items-center gap-3 p-3">
                      <Icon type={ex.type} className="w-6 h-6 text-blue-200" />
                      <div className="flex-1">
                        <p className="font-medium text-white">{ex.name}</p>
                        <p className="text-xs text-blue-300">{ex.desc}</p>
                      </div>
                      <div className="text-xs text-blue-300 text-right">
                        {ex.mode === "interval" && <span>{ex.work}/{ex.rest}s</span>}
                        {ex.mode === "tabata" && <span>{ex.sets}×{ex.work}/{ex.rest}s</span>}
                        {ex.mode === "hold" && <span>Hold {ex.hold}s</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Cool-down */}
              {!skipCooldown && (
                <div className="space-y-2">
                  <p className="text-sm text-blue-900 font-semibold">Cool-down • 5:00</p>
                  <div className="border rounded-xl divide-y" style={{ backgroundColor: '#1e3a8a', borderColor: '#1e40af' }}>
                    {day.cooldown.map((ex, i) => (
                      <div key={`cd-${i}`} className="flex items-center gap-3 p-3">
                        <Icon type={ex.type} className="w-6 h-6 text-blue-200" />
                        <div className="flex-1">
                          <p className="font-medium text-white">{ex.name}</p>
                          <p className="text-xs text-blue-300">{ex.desc}</p>
                        </div>
                        <span className="text-xs text-blue-300">{ex.mode === "interval" ? `${ex.work}/${ex.rest}s` : `Hold ${ex.hold}s`}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Helpers */}
              <div className="mt-4 grid grid-cols-1 gap-2">
                <button onClick={() => { const msg = "Voice ready."; say(msg); }} className="px-3 py-2 rounded-lg border border-blue-400 text-blue-900 font-medium hover:bg-blue-100">Test Voice</button>
                <div className="flex items-center gap-2">
                  <button onClick={wakeActive ? releaseWake : requestWake} className={`px-3 py-2 rounded-lg border font-medium ${wakeActive ? "bg-green-600 text-white border-green-600" : "border-blue-400 text-blue-900 hover:bg-blue-100"}`}>
                    {wakeActive ? "Screen Awake (On)" : wakeSupported ? "Keep Screen Awake" : "Keep Screen Awake (Not supported)"}
                  </button>
                  <span className="text-xs text-blue-700">Start once to allow voice & wake lock.</span>
                </div>
              </div>
            </section>

            {/* Trainer */}
            <section className="bg-white rounded-2xl shadow p-4">
              <div className="flex items-center justify-between mb-3">
                <h2 className="font-semibold text-lg">Trainer</h2>
                <span className="text-sm text-gray-500">Total {fmt(totalDuration)}</span>
              </div>

              <div className="sr-only" aria-live="polite">{currentStep.label} {state.remaining} seconds left.</div>

              <div className="rounded-2xl p-5 border mb-4" style={{ background: 'linear-gradient(to bottom right, #1e3a8a, #3b82f6)', borderColor: '#1e40af' }}>
                <div className="flex items-center gap-4">
                  <Icon type={currentStep.icon} className="w-16 h-16 text-white" />
                  <div className="flex-1">
                    <p className="text-sm text-blue-200 font-semibold">{currentStep.type === "work" ? "WORK" : currentStep.type === "pause" ? "PAUSED" : "REST"}</p>
                    <p className="text-xl font-bold leading-tight text-white">{currentStep.label}</p>
                  </div>
                  <div className="text-4xl font-mono tabular-nums text-white font-bold" aria-label="Remaining time">{currentStep.type === "pause" ? "—" : fmt(state.remaining)}</div>
                </div>
                <div className="mt-4 h-3 bg-blue-900/40 rounded-full overflow-hidden" role="progressbar" aria-valuemin={0} aria-valuemax={100} aria-valuenow={progress}>
                  <div className="h-full bg-white shadow-lg" style={{ width: `${progress}%`, transition: 'width 1s linear' }} />
                </div>
              </div>

              <div className="mb-4 border rounded-xl p-3" style={{ backgroundColor: '#eff6ff', borderColor: '#3b82f6' }}>
                <div className="flex items-center gap-2 mb-1">
                  <Icon type={currentExercise?.type || "core"} className="w-6 h-6 text-blue-600" />
                  <p className="font-semibold text-blue-900">Form Tips — {currentExercise?.name || "Exercise"}</p>
                </div>
                <p className="text-xs text-blue-700 mb-1">{currentExercise?.desc}</p>
                <ul className="list-disc list-inside text-sm text-blue-800">
                  {(currentExercise?.cues || []).map((c, i) => (<li key={i}>{c}</li>))}
                </ul>
              </div>

              <div className="flex flex-wrap gap-2 mb-4">
                {!state.running ? (<button onClick={start} className="px-4 py-2 rounded-xl bg-blue-600 text-white shadow">Start</button>) : (<button onClick={pause} className="px-4 py-2 rounded-xl bg-amber-500 text-white shadow">Pause</button>)}
                <button onClick={skip} className="px-4 py-2 rounded-xl bg-gray-100 border">Skip</button>
                <button onClick={reset} className="px-4 py-2 rounded-xl bg-gray-100 border">Reset</button>
              </div>

              <div className="max-h-64 overflow-auto border rounded-xl" style={{ backgroundColor: '#dbeafe', borderColor: '#60a5fa' }}>
                {queue.map((st, i) => (
                  <div key={i} className={`flex items-center gap-3 p-2 text-sm ${i === state.stepIdx ? "bg-blue-300" : ""}`}>
                    <Icon type={st.icon} className="w-6 h-6 text-blue-700" />
                    <span className="flex-1 text-blue-900 font-medium">{st.label}</span>
                    <span className="font-mono text-blue-800">{fmt(st.seconds)}</span>
                  </div>
                ))}
              </div>
            </section>

            {/* Logs */}
            <section className="md:col-span-2 bg-white rounded-2xl shadow p-4">
              <div className="flex items-center justify-between mb-3">
                <h2 className="font-semibold text-lg">Progress</h2>
                <div className="flex gap-2 items-center flex-wrap">
                  <button onClick={exportCSV} className="px-3 py-1.5 border rounded-md">Export CSV</button>
                  <label className="flex items-center gap-2 text-sm text-gray-700 border rounded-md px-2 py-1">
                    <input type="checkbox" checked={appendMode} onChange={(e)=>setAppendMode(e.target.checked)} />
                    Append since last export
                  </label>
                  <button onClick={() => { localStorage.removeItem("hiitExportCursor"); }} className="px-3 py-1.5 border rounded-md">Reset Append Marker</button>
                  <button onClick={() => { setLogs([]); localStorage.removeItem("hiitLogs"); }} className="px-3 py-1.5 border rounded-md">Clear</button>
                </div>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left border-b">
                      <th className="py-2 pr-3">Date</th>
                      <th className="py-2 pr-3">Week</th>
                      <th className="py-2 pr-3">Day</th>
                      <th className="py-2 pr-3">Title</th>
                      <th className="py-2 pr-3">Duration</th>
                    </tr>
                  </thead>
                  <tbody>
                    {logs.length === 0 && (<tr><td className="py-3 text-gray-500" colSpan={5}>No workouts logged yet.</td></tr>)}
                    {logs.map((l, i) => (
                      <tr key={i} className="border-b last:border-0">
                        <td className="py-2 pr-3">{new Date(l.ts).toLocaleString()}</td>
                        <td className="py-2 pr-3">{l.week}</td>
                        <td className="py-2 pr-3">{l.day}</td>
                        <td className="py-2 pr-3">{l.title}</td>
                        <td className="py-2 pr-3">{fmt(l.duration)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          </main>

          <footer className="py-8 text-center text-xs text-blue-700">Add to Home Screen for full-screen. Use "Keep Screen Awake" to prevent auto-lock.</footer>
        </div>
      );
    }

    function VoiceSelect({ voices, voice, onChange }) {
      return (
        <select className="text-sm border rounded-md px-2 py-1 w-full" onChange={(e) => onChange(voices.find((v) => v.name === e.target.value) || null)} value={voice?.name || ""}>
          <option value="">System Default</option>
          {voices.map((v) => (<option key={v.name} value={v.name}>{v.lang} — {v.name}</option>))}
        </select>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
